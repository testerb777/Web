<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bag Shop – Prototype</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet" />

  <!-- Bootstrap 5 & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

  <style>
    :root{
      --c-bg:#d7a9e3;
      --c-ink:#111118;
      --c-pink:#ff4ca3;
      --c-pink-2:#ff66c4;
      --c-primary:#e91e63;
      --c-primary-2:#ff5aa5;
      --radius-xl:28px;
    }

    html,body{height:100%;}
    body{
      font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--c-ink);
      background: var(--c-bg);
      overflow-x:hidden;
    }

    /* fluffy pink circles (fixed across the site) */
    .bg-fluff{
      position:fixed;
      inset:0;
      z-index:-2;
      pointer-events:none;
      background:
        radial-gradient(circle at 7% 14%, rgba(255, 105, 180,0.85) 0 10%, rgba(255,105,180,0.25) 38%, transparent 42%) no-repeat,
        radial-gradient(circle at 90% 16%, rgba(255, 105, 180,0.8) 0 9%, rgba(255,105,180,0.25) 36%, transparent 40%) no-repeat,
        radial-gradient(circle at 18% 72%, rgba(255, 105, 180,0.85) 0 9%, rgba(255,105,180,0.25) 36%, transparent 40%) no-repeat,
        radial-gradient(circle at 75% 72%, rgba(255, 105, 180,0.85) 0 10%, rgba(255,105,180,0.25) 38%, transparent 42%) no-repeat;
      background-size: 380px 380px, 440px 440px, 420px 420px, 460px 460px;
      filter: blur(2px) saturate(110%);
    }

    /* Frosted white card look */
    .glass{
      background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.82));
      backdrop-filter: blur(6px);
      border-radius: var(--radius-xl);
      box-shadow: 0 20px 50px rgba(0,0,0,.14);
    }

    .logo-txt{
      font-weight:800; letter-spacing:.5px;
    }

    .btn-candy{
      --bs-btn-color:#fff;
      --bs-btn-bg:var(--c-primary);
      --bs-btn-border-color:var(--c-primary);
      --bs-btn-hover-bg:var(--c-primary-2);
      --bs-btn-hover-border-color:var(--c-primary-2);
      --bs-btn-focus-shadow-rgb:233,30,99;
      border-radius:999px;
      padding:.8rem 1.4rem;
      font-weight:600;
    }

    .hero{
      padding-block: clamp(2.5rem, 4vw + 2rem, 6rem);
    }
    .hero h1{
      font-weight:800;
      font-size: clamp(2.2rem, 3.8vw + 1rem, 5rem);
      line-height:1.02;
      text-shadow: 0 6px 0 rgba(0,0,0,.18);
    }

    .tilt{
      transform: rotate(-10deg);
      filter: drop-shadow(0 35px 40px rgba(0,0,0,.25));
    }

    /* Sections visibility, for hash "routing" */
    section[data-view]{display:none;}
    section[data-view].active{display:block;}

    /* Product card */
    .product-card{
      border: none;
      border-radius: 24px;
      overflow: hidden;
      background:linear-gradient(180deg,#ff6fbb 0%, #ff4ca3 100%);
      color:#fff;
      box-shadow: 0 18px 40px rgba(0,0,0,.18);
    }
    .product-card img{
      object-fit: cover; height: 220px; width: 100%;
      background:#fff;
      border-bottom-left-radius: 18px;border-bottom-right-radius: 18px;
    }
    .price{
      font-weight:800;
      font-size:1.1rem;
    }

    .searchbar{
      background: linear-gradient(180deg,#ffd1ea,#ffc3e1);
      border-radius: 999px;
      box-shadow: 0 10px 18px rgba(0,0,0,.14) inset, 0 4px 18px rgba(0,0,0,.15);
      padding: .35rem .8rem;
    }

    .step-title{
      font-weight:800;
      font-size: clamp(1.6rem, .8vw + 1.4rem, 2rem);
    }

    .checkout-box{
      max-width: 520px;
    }

    footer{
      color:#fff;
      background:linear-gradient(90deg,#6e4ca5,#43307c);
      border-top-left-radius: 40px;border-top-right-radius: 40px;
      box-shadow: 0 -10px 20px rgba(0,0,0,.15) inset;
    }

    .secure-lock{
      font-size: 1.2rem; font-weight:600;
    }

    .form-control, .form-select{
      border-radius: 14px;
      padding:.8rem 1rem;
    }

    .nav-pills .nav-link{
      border-radius: 999px;
      font-weight:600;
    }

    .wavy-underline{
      text-decoration: underline wavy rgba(0,0,0,.2) 2px;
      text-underline-offset: 4px;
    }

    .avatar{
      width:38px;height:38px;border-radius:50%;background:#fff;border:2px solid #1112;display:inline-grid;place-items:center;
    }
    .avatar i{font-size:1.1rem;}
    /* Small helpers */
    .cursor{cursor:pointer;}
  </style>
</head>
<body>
  <div class="bg-fluff"></div>

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg bg-transparent sticky-top">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-2" href="#home" onclick="go('#home')">
        <span class="avatar"><i class="bi bi-handbag"></i></span>
        <span class="logo-txt">BAG SHOP</span>
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div id="nav" class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
          <li class="nav-item"><a class="nav-link" href="#shop" onclick="go('#shop')">Shop</a></li>
          <li class="nav-item"><a class="nav-link" href="#login" onclick="go('#login')">Login</a></li>
          <li class="nav-item ms-lg-3">
            <a class="btn btn-dark rounded-pill px-3" href="#checkout" onclick="go('#checkout')">
              <i class="bi bi-bag me-1"></i>Cart
              <span class="badge bg-danger ms-2" id="cartCount">0</span>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <main>
    <!-- HERO / HOME -->
    <section id="home" data-view class="hero active">
      <div class="container">
        <div class="row align-items-center g-5">
          <div class="col-lg-6">
            <p class="mb-2 fw-semibold text-dark-50">BAG SHOP</p>
            <h1 class="mb-4">A Bag that<br> Make You <span class="wavy-underline">Fashionable</span></h1>
            <div class="d-flex flex-wrap gap-3">
              <button class="btn btn-candy" onclick="quickBuy('luvane')">
                <i class="bi bi-lightning-charge-fill me-1"></i>Buy Now
              </button>
              <a class="btn btn-light rounded-pill px-4" href="#shop" onclick="go('#shop')">
                Shop All
              </a>
            </div>
          </div>

          <div class="col-lg-6 text-center">
            <img class="img-fluid tilt" alt="featured bag"
                 src="https://images.unsplash.com/photo-1525966222134-fcfa99b8ae77?auto=format&fit=crop&w=1100&q=80"/>
          </div>
        </div>
      </div>
    </section>

    <!-- SHOP GRID -->
    <section id="shop" data-view>
      <div class="container py-4 pt-lg-5">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-4">
          <div class="d-flex align-items-center gap-2">
            <h2 class="logo-txt mb-0">BAG SHOP</h2>
          </div>

          <div class="searchbar d-flex align-items-center" style="min-width:260px; width: min(520px, 100%);">
            <i class="bi bi-search ps-3 me-2"></i>
            <input id="searchInput" class="form-control border-0 bg-transparent" placeholder="Search bags..." oninput="renderProducts()">
          </div>

          <div class="d-flex align-items-center gap-2">
            <div class="avatar"><i class="bi bi-person"></i></div>
            <span class="fw-semibold">NAMA</span>
          </div>
        </div>

        <div id="productRow" class="row g-4"></div>

        <div class="mt-5 text-center">
          <span class="text-dark-50 d-block mb-1">FOLLOW US</span>
          <div class="d-flex justify-content-center gap-3 fs-4">
            <a class="text-dark" href="#"><i class="bi bi-youtube"></i></a>
            <a class="text-dark" href="#"><i class="bi bi-instagram"></i></a>
            <a class="text-dark" href="#"><i class="bi bi-facebook"></i></a>
            <a class="text-dark" href="#"><i class="bi bi-tiktok"></i></a>
          </div>
        </div>
      </div>
      <footer class="container-fluid mt-5 py-4 text-center">
        <small>Copyright © <span id="year1"></span> Bag Shop. All rights reserved.</small>
      </footer>
    </section>

    <!-- CHECKOUT SUMMARY -->
    <section id="checkout" data-view>
      <div class="container py-5">
        <div class="d-flex align-items-center gap-2 mb-4">
          <i class="bi bi-cart-check-fill fs-4"></i>
          <h2 class="step-title mb-0">Checkout</h2>
        </div>

        <div class="row g-4">
          <div class="col-lg-7">
            <div class="glass p-3 p-md-4">
              <h6 class="fw-bold mb-3">Items</h6>
              <div id="checkoutItems" class="vstack gap-3"></div>
              <div class="d-flex justify-content-between border-top pt-3 mt-3">
                <strong>Total</strong>
                <strong id="checkoutTotal">Rp —</strong>
              </div>
            </div>
          </div>
          <div class="col-lg-5">
            <div class="glass p-3 p-md-4 checkout-box ms-lg-auto">
              <h6 class="fw-bold mb-3"><i class="bi bi-geo-alt-fill me-1"></i> Shipping To</h6>
              <div id="shipMini" class="small text-muted">Not set yet.</div>
              <hr>
              <div class="d-grid gap-2">
                <a class="btn btn-light rounded-pill" href="#shipping" onclick="go('#shipping')">
                  <i class="bi bi-pencil"></i> Enter Shipping Details
                </a>
                <button class="btn btn-candy" onclick="proceedToPayment()">
                  Proceed to Payment
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="text-center mt-5">
          <a class="btn btn-outline-dark rounded-pill" href="#shop" onclick="go('#shop')">
            <i class="bi bi-arrow-left"></i> Continue Shopping
          </a>
        </div>
      </div>
    </section>

    <!-- SHIPPING FORM -->
    <section id="shipping" data-view>
      <div class="container py-5">
        <h2 class="text-center step-title mb-4">BAG SHOP <span class="text-muted">| Shipping</span></h2>
        <div class="glass mx-auto p-4 p-md-5" style="max-width:780px;">
          <h3 class="text-center mb-4 fw-bold">Shipping Details</h3>
          <form id="shippingForm" class="vstack gap-3">
            <div class="row g-3">
              <div class="col-md-12">
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-person"></i></span>
                  <input required name="fullName" class="form-control" placeholder="Full Name">
                </div>
              </div>
              <div class="col-md-12">
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-telephone"></i></span>
                  <input required name="phone" class="form-control" placeholder="Phone Number" inputmode="numeric">
                </div>
              </div>
              <div class="col-md-12">
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
                  <input required name="address" class="form-control" placeholder="Address">
                </div>
              </div>
              <div class="col-md-6">
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-plus-circle"></i></span>
                  <input required name="city" class="form-control" placeholder="City">
                </div>
              </div>
              <div class="col-md-6">
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-mailbox"></i></span>
                  <input required name="postal" class="form-control" placeholder="Postal Code" inputmode="numeric">
                </div>
              </div>
              <div class="col-md-12">
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-map"></i></span>
                  <input required name="province" class="form-control" placeholder="Province">
                </div>
              </div>
              <div class="col-md-12">
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-chat-dots"></i></span>
                  <input name="note" class="form-control" placeholder="Delivery Note (Optional)">
                </div>
              </div>
            </div>
            <div class="text-center pt-2">
              <button class="btn btn-candy px-5" type="submit">Confirm Shipping</button>
            </div>
          </form>
        </div>
        <p class="text-center text-muted mt-4">© <span id="year2"></span> Bag Shop. All rights reserved.</p>
      </div>
    </section>

    <!-- PAYMENT FORM -->
    <section id="payment" data-view>
      <div class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="step-title mb-0">Payment Method</h2>
          <div class="secure-lock"><i class="bi bi-lock-fill me-2"></i>Secure Payment</div>
        </div>

        <div class="glass p-4 p-md-5 mx-auto" style="max-width:780px;">
          <ul class="nav nav-pills justify-content-center gap-2 mb-4" id="payTabs">
            <li class="nav-item"><button class="nav-link active" data-method="bank">BCA</button></li>
            <li class="nav-item"><button class="nav-link" data-method="card">Credit Card</button></li>
            <li class="nav-item"><button class="nav-link" data-method="ewallet">e-Wallet</button></li>
          </ul>

          <form id="paymentForm" class="vstack gap-3">
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label">Cardholder Name</label>
                <input required id="cardName" class="form-control" placeholder="Your Name">
              </div>
              <div class="col-12">
                <label class="form-label">Card Number</label>
                <input required id="cardNumber" class="form-control" inputmode="numeric" placeholder="•••• •••• •••• ••••">
              </div>
              <div class="col-md-6">
                <label class="form-label">Expiry Date</label>
                <input required id="cardExp" class="form-control" placeholder="MM / YY">
              </div>
              <div class="col-md-6">
                <label class="form-label">CVV</label>
                <input required id="cardCvv" class="form-control" inputmode="numeric" placeholder="•••">
              </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-2">
              <span class="fw-semibold">Total Amount</span>
              <span class="fs-5 fw-bold text-danger" id="payTotal">Rp —</span>
            </div>

            <div class="d-grid pt-2">
              <button class="btn btn-candy" type="submit">Confirm Payment</button>
            </div>

            <div class="text-muted small mt-2">
              <i class="bi bi-shield-lock me-1"></i> Your payment is secured by SSL encryption (256-bit).
            </div>
          </form>
        </div>

        <p class="text-center text-muted mt-4">© <span id="year3"></span> Bag Shop. All rights reserved.</p>
      </div>
    </section>

    <!-- PAYMENT SUCCESS -->
    <section id="success" data-view>
      <div class="container py-5">
        <div class="glass p-4 p-md-5 mx-auto text-center" style="max-width:820px;">
          <div class="display-5 mb-3">✅</div>
          <h2 class="mb-3 fw-bold">Payment Successful!</h2>
          <p class="lead">Thank you for shopping with Bag Shop <span class="text-danger">💗</span><br>
             Your order <strong id="orderId">#BGS12345</strong> has been confirmed.</p>
          <div class="d-flex flex-wrap justify-content-center gap-3 mt-4">
            <button class="btn btn-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#orderModal">
              View Order Details
            </button>
            <a class="btn btn-outline-dark rounded-pill px-4" href="#shop" onclick="resetCart(); go('#shop')">Continue Shopping</a>
          </div>
        </div>
        <p class="text-center text-muted mt-4">© <span id="year4"></span> Bag Shop. All rights reserved.</p>
      </div>
    </section>

    <!-- LOGIN -->
    <section id="login" data-view>
      <div class="container py-5">
        <div class="row align-items-center g-5">
          <div class="col-lg-6">
            <div class="glass p-4 p-md-5">
              <h2 class="mb-4 fw-bold">Welcome Back!</h2>
              <form class="vstack gap-3">
                <input class="form-control" placeholder="Email or Username">
                <input type="password" class="form-control" placeholder="Password">
                <div class="d-flex align-items-center justify-content-between">
                  <div class="form-check">
                    <input class="form-check-input" id="remember" type="checkbox">
                    <label class="form-check-label" for="remember">Remember me</label>
                  </div>
                  <a href="#" class="link-dark">Forgot password?</a>
                </div>
                <button type="button" class="btn btn-candy">Login</button>
                <div class="text-center small">Don't have an account? <a href="#" class="link-dark fw-semibold">Sign up</a></div>
              </form>
              <p class="text-muted small mt-4 mb-0">© <span id="year5"></span> Bag Shop. All rights reserved.</p>
            </div>
          </div>
          <div class="col-lg-6 text-center">
            <img class="img-fluid tilt" alt="bag login visual"
              src="https://images.unsplash.com/photo-1610276198568-eb6d0ff53e48?auto=format&fit=crop&w=1100&q=80">
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- ORDER DETAILS MODAL -->
  <div class="modal fade" id="orderModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Order Details</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="orderDetail"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-dark" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
    <div id="toast" class="toast align-items-center text-bg-dark border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="toastMsg">Added to cart</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <!-- Bootstrap Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ---------- Data ----------
    const money = new Intl.NumberFormat('id-ID', { style:'currency', currency:'IDR', maximumFractionDigits:0 });
    const products = [
      {
        id:'dazzle',
        name:'DAZZLE — Maison du Luxe',
        price:1000000,
        color:'Navy',
        img:'https://images.unsplash.com/photo-1620799139504-5c0a6a58224c?auto=format&fit=crop&w=1200&q=80'
      },
      {
        id:'valein',
        name:'VALEIN — Maison du Luxe',
        price:1000000,
        color:'Tan',
        img:'https://images.unsplash.com/photo-1548036328-c9fa89d128fa?auto=format&fit=crop&w=1200&q=80'
      },
      {
        id:'luvane',
        name:'LUVANE — Maison du Luxe',
        price:1000000,
        color:'Rose',
        img:'https://images.unsplash.com/photo-1540575467063-178a50c2df87?auto=format&fit=crop&w=1200&q=80'
      },
      {
        id:'olyvia',
        name:'OLYVIA — Maison du Luxe',
        price:1000000,
        color:'Pearl',
        img:'https://images.unsplash.com/photo-1618374954327-4161f0b8c1b6?auto=format&fit=crop&w=1200&q=80'
      }
    ];

    const state = {
      cart: [],
      shipping: null,
      method: 'bank',
      orderId: null
    };

    // ---------- Utilities ----------
    const $ = (sel, root=document)=>root.querySelector(sel);
    const $$= (sel, root=document)=>[...root.querySelectorAll(sel)];
    const toast = new bootstrap.Toast(document.getElementById('toast'));

    function setYears(){
      ['year1','year2','year3','year4','year5'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.textContent = new Date().getFullYear();
      });
    }

    function go(hash){
      if(typeof hash === 'string'){ location.hash = hash; }
      const target = location.hash || '#home';
      $$('section[data-view]').forEach(s=>s.classList.remove('active'));
      const active = $(target);
      if(active) active.classList.add('active');

      if(target === '#shop') renderProducts();
      if(['#checkout','#payment'].includes(target)) refreshTotals();
      if(target === '#checkout') buildCheckout();
      if(target === '#payment') $('#payTotal').textContent = money.format(sumCart());
    }
    window.addEventListener('hashchange', go);
    document.addEventListener('DOMContentLoaded', () => { setYears(); go(); renderProducts(); updateMiniShip(); });

    // ---------- Shop ----------
    function renderProducts(){
      const q = ($('#searchInput')?.value || '').toLowerCase().trim();
      const row = $('#productRow');
      if(!row) return;
      row.innerHTML = '';

      products
       .filter(p => p.name.toLowerCase().includes(q))
       .forEach(p=>{
        const col = document.createElement('div');
        col.className = 'col-12 col-sm-6 col-lg-3';
        col.innerHTML = `
          <div class="product-card h-100 d-flex flex-column">
            <div class="p-3 pb-0">
              <h4 class="fw-bolder mb-1">${p.name.split('—')[0].trim()}</h4>
              <div class="text-uppercase opacity-75 small mb-2">Maison du Luxe</div>
              <div class="price mb-2">${money.format(p.price)}</div>
              <div class="d-flex gap-2">
                <button class="btn btn-light btn-sm rounded-pill" onclick="addToCart('${p.id}')">
                  <i class="bi bi-basket2-fill me-1"></i>Add to Cart
                </button>
                <button class="btn btn-dark btn-sm rounded-pill" onclick="buyNow('${p.id}')">Buy</button>
              </div>
            </div>
            <img src="${p.img}" alt="${p.name}">
          </div>`;
        row.appendChild(col);
      });

      if(!row.children.length){
        row.innerHTML = `<div class="text-center py-5"><h4>No products found.</h4></div>`;
      }
    }

    function addToCart(pid){
      const p = products.find(x=>x.id===pid);
      if(!p) return;
      const existing = state.cart.find(i=>i.id===pid);
      if(existing) existing.qty++;
      else state.cart.push({ id:p.id, name:p.name, price:p.price, img:p.img, qty:1 });

      updateCartBadge();
      showToast(`${p.name.split('—')[0].trim()} added to cart`);
    }

    function buyNow(pid){
      addToCart(pid); go('#checkout');
    }

    function quickBuy(pid){ addToCart(pid); go('#checkout'); }
    function sumCart(){ return state.cart.reduce((n,i)=>n + i.price * i.qty, 0); }
    function updateCartBadge(){ $('#cartCount').textContent = state.cart.reduce((n,i)=>n+i.qty,0); }

    function showToast(msg){
      $('#toastMsg').textContent = msg;
      toast.show();
    }

    // ---------- Checkout ----------
    function buildCheckout(){
      const box = $('#checkoutItems');
      box.innerHTML = '';
      if(state.cart.length === 0){
        box.innerHTML = `<div class="text-center py-4">
          <p class="mb-3">Your cart is empty.</p>
          <a class="btn btn-dark rounded-pill" href="#shop" onclick="go('#shop')">Shop Bags</a>
        </div>`;
      }else{
        state.cart.forEach((i,idx)=>{
          const row = document.createElement('div');
          row.className = 'd-flex align-items-center gap-3';
          row.innerHTML = `
            <img src="${i.img}" alt="${i.name}" class="rounded" style="width:72px;height:72px;object-fit:cover">
            <div class="flex-grow-1">
              <div class="fw-semibold">${i.name}</div>
              <div class="small text-muted">Qty:
                <button class="btn btn-sm btn-outline-dark px-2 py-0" onclick="chgQty(${idx},-1)">−</button>
                <span class="mx-2">${i.qty}</span>
                <button class="btn btn-sm btn-outline-dark px-2 py-0" onclick="chgQty(${idx},1)">+</button>
              </div>
            </div>
            <div class="fw-bold">${money.format(i.price * i.qty)}</div>
            <button class="btn btn-sm btn-link text-danger" title="Remove" onclick="removeItem(${idx})"><i class="bi bi-trash"></i></button>
          `;
          box.appendChild(row);
        });
      }
      refreshTotals();
    }

    function refreshTotals(){
      const total = sumCart();
      const el1 = $('#checkoutTotal'); if(el1) el1.textContent = money.format(total);
      const el2 = $('#payTotal'); if(el2) el2.textContent = money.format(total);
      updateCartBadge();
    }

    function chgQty(idx,delta){
      const item = state.cart[idx]; if(!item) return;
      item.qty = Math.max(1, item.qty + delta);
      buildCheckout();
    }
    function removeItem(idx){
      state.cart.splice(idx,1);
      buildCheckout();
    }

    // ---------- Shipping ----------
    $('#shippingForm')?.addEventListener('submit', (e)=>{
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target).entries());
      state.shipping = data;
      updateMiniShip();
      showToast('Shipping saved');
      go('#checkout');
    });

    function updateMiniShip(){
      const mini = $('#shipMini');
      if(!mini) return;
      if(!state.shipping){
        mini.textContent = 'Not set yet.';
      }else{
        mini.innerHTML = `
          <div class="small">${state.shipping.fullName} • ${state.shipping.phone}</div>
          <div class="small">${state.shipping.address}, ${state.shipping.city}, ${state.shipping.province} ${state.shipping.postal}</div>
          <div class="small text-muted">${state.shipping.note || ''}</div>
        `;
      }
    }

    function proceedToPayment(){
      if(state.cart.length === 0) return showToast('Your cart is empty');
      if(!state.shipping) return showToast('Please add shipping details first');
      go('#payment');
    }

    // ---------- Payment ----------
    // Toggle methods (cosmetic)
    $('#payTabs')?.addEventListener('click', (e)=>{
      if(e.target.matches('[data-method]')){
        $$('#payTabs .nav-link').forEach(b=>b.classList.remove('active'));
        e.target.classList.add('active');
        state.method = e.target.getAttribute('data-method');
      }
    });

    $('#paymentForm')?.addEventListener('submit', (e)=>{
      e.preventDefault();
      // simple validations
      const number = $('#cardNumber').value.replace(/\s|-/g,'');
      const exp = $('#cardExp').value.trim();
      const cvv = $('#cardCvv').value.trim();

      if(!luhn(number)) return showToast('Invalid card number');
      if(!/^\d{2}\s*\/\s*\d{2}$/.test(exp)) return showToast('Use MM / YY for expiry');
      if(!/^\d{3,4}$/.test(cvv)) return showToast('Invalid CVV');

      // place order
      state.orderId = '#BGS' + Math.floor(Math.random()*9e5 + 1e5);
      $('#orderId').textContent = state.orderId;

      // build order modal details
      const lines = state.cart.map(i=>`<li class="d-flex justify-content-between"><span>${i.qty} × ${i.name}</span><strong>${money.format(i.price*i.qty)}</strong></li>`).join('');
      $('#orderDetail').innerHTML = `
        <div class="vstack gap-2">
          <div><strong>Order ID:</strong> ${state.orderId}</div>
          <div><strong>Ship To:</strong> ${state.shipping.fullName}, ${state.shipping.address}, ${state.shipping.city}, ${state.shipping.province} ${state.shipping.postal}</div>
          <hr>
          <ul class="list-unstyled vstack gap-2">${lines}</ul>
          <hr>
          <div class="d-flex justify-content-between">
            <span class="fw-semibold">Total</span><strong>${money.format(sumCart())}</strong>
          </div>
          <div class="text-muted small">Method: ${state.method.toUpperCase()}</div>
        </div>
      `;

      go('#success');
    });

    function luhn(num){
      // Luhn algorithm
      let sum = 0, dbl = false;
      for(let i=num.length-1; i>=0; i--){
        let d = parseInt(num[i] || '0',10);
        if(dbl){ d*=2; if(d>9) d-=9; }
        sum += d; dbl=!dbl;
      }
      return sum % 10 === 0;
    }

    function resetCart(){
      state.cart = [];
      refreshTotals();
    }

    // initial render
    updateCartBadge();
  </script>
</body>
</html>
